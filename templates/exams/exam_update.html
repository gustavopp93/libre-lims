{% extends "base.html" %}

{% block title %}Editar Examen - {{ company.business_name }}{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    {% include 'includes/sidebar.html' %}

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        {% include 'includes/header.html' with page_title="Editar Examen" %}

        <!-- Main Content Area -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            {% include 'includes/breadcrumbs.html' %}
<div class="max-w-4xl mx-auto" x-data="{ hasComponents: {% if form.has_components.value != None %}{{ form.has_components.value|yesno:'true,false' }}{% else %}{{ exam.has_components|yesno:'true,false' }}{% endif %} }">
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-6">Editar Examen: {{ exam.name }}</h3>

        <!-- Form -->
        <form method="post">
            {% csrf_token %}

            {% if form.errors or component_formset.errors %}
            <div class="mb-4 p-4 bg-red-100 text-red-700 rounded">
                <p class="font-bold">Por favor corrija los siguientes errores:</p>
                <ul class="list-disc list-inside">
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    {% for formset_form in component_formset %}
                        {% for field in formset_form %}
                            {% for error in field.errors %}
                                <li>Componente {{ forloop.parentloop.counter }}: {{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in formset_form.non_field_errors %}
                            <li>Componente {{ forloop.counter }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in component_formset.non_form_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="space-y-4">
                <!-- Código (readonly) -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Código del Examen
                    </label>
                    <div class="bg-gray-100 border border-gray-300 rounded w-full py-2 px-3 text-gray-600">
                        {{ exam.code|default:"-" }}
                    </div>
                    <p class="text-gray-500 text-xs mt-1">Este campo no se puede editar</p>
                </div>

                <!-- Nombre (editable) -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="{{ form.name.id_for_label }}">
                        {{ form.name.label }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.name }}
                </div>

                <!-- Categoría -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="{{ form.category.id_for_label }}">
                        {{ form.category.label }}
                    </label>
                    {{ form.category }}
                </div>

                <!-- Precio (editable) -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="{{ form.price.id_for_label }}">
                        {{ form.price.label }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.price }}
                </div>

                <!-- Has Components -->
                <div class="flex items-center">
                    {{ form.has_components }}
                    <label class="ml-2 text-gray-700 text-sm font-bold" for="{{ form.has_components.id_for_label }}">
                        {{ form.has_components.label }}
                    </label>
                </div>

                <!-- Components Section -->
                <div x-show="hasComponents" x-transition class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-md font-semibold text-gray-700">Componentes del Examen</h4>
                        <button type="button" id="add-component" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                            Agregar Componente
                        </button>
                    </div>

                    {{ component_formset.management_form }}

                    <div id="component-forms" class="space-y-3">
                        {% for form in component_formset %}
                        <div class="component-form p-4 bg-gray-50 rounded border flex items-center gap-3 cursor-move hover:bg-gray-100 transition-colors" data-formset-form>
                            <div class="drag-handle text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing flex-shrink-0">
                                <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1">
                                <label class="block text-gray-700 text-sm font-bold mb-2">
                                    Examen Componente
                                </label>
                                {{ form.component_exam }}
                                {{ form.order }}
                                {{ form.id }}
                            </div>
                            <div class="flex-shrink-0">
                                <button type="button" class="remove-component text-red-600 hover:text-red-800">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                                {{ form.DELETE }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Template oculto para clonar cuando no hay componentes -->
                    <template id="component-template">
                        <div class="component-form p-4 bg-gray-50 rounded border flex items-center gap-3 cursor-move hover:bg-gray-100 transition-colors" data-formset-form>
                            <div class="drag-handle text-gray-400 hover:text-gray-600 cursor-grab active:cursor-grabbing flex-shrink-0">
                                <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1">
                                <label class="block text-gray-700 text-sm font-bold mb-2">
                                    Examen Componente
                                </label>
                                <select name="component_items-__prefix__-component_exam" id="id_component_items-__prefix__-component_exam" class="template-select shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                                </select>
                                <input type="hidden" name="component_items-__prefix__-order" value="0" id="id_component_items-__prefix__-order">
                                <input type="hidden" name="component_items-__prefix__-id" id="id_component_items-__prefix__-id">
                            </div>
                            <div class="flex-shrink-0">
                                <button type="button" class="remove-component text-red-600 hover:text-red-800">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                                <input type="checkbox" name="component_items-__prefix__-DELETE" id="id_component_items-__prefix__-DELETE" style="display:none;">
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex items-center justify-end space-x-4 mt-6">
                <a href="{% url 'exams_list' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Cancelar
                </a>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>
        </main>
    </div>
</div>

<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-component');
    const formsContainer = document.getElementById('component-forms');

    if (!addButton || !formsContainer) return;

    // Función para actualizar el orden de los componentes
    function updateComponentOrder() {
        const forms = formsContainer.querySelectorAll('[data-formset-form]:not([style*="display: none"])');
        forms.forEach((form, index) => {
            const orderInput = form.querySelector('input[name*="-order"]');
            if (orderInput) {
                orderInput.value = index + 1;
            }
        });
    }

    // Inicializar SortableJS para drag & drop
    const sortable = new Sortable(formsContainer, {
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'bg-blue-100',
        chosenClass: 'bg-blue-50',
        dragClass: 'opacity-50',
        onEnd: function() {
            // Solo actualizar el orden, NO los índices del formset
            updateComponentOrder();
        }
    });

    // ID del examen padre para excluirlo de las búsquedas
    const parentExamId = {{ exam.id }};

    // Inicializar TomSelect en los selectores existentes de componentes
    function initializeTomSelect(selectElement) {
        if (!selectElement) return;

        // Verificar si ya tiene TomSelect y destruirlo
        if (selectElement.tomselect) {
            selectElement.tomselect.destroy();
        }

        // Obtener valor actual del select (si existe)
        const currentValue = selectElement.value;
        const currentText = selectElement.options[selectElement.selectedIndex]?.text || '';

        new TomSelect(selectElement, {
            valueField: 'id',
            labelField: 'name',
            searchField: 'name',
            placeholder: 'Buscar examen...',
            options: currentValue ? [{id: currentValue, name: currentText}] : [],
            items: currentValue ? [currentValue] : [],
            load: function(query, callback) {
                if (!query.length) return callback();
                fetch(`/api/exams/search/?name=${encodeURIComponent(query)}&parent_exam_id=${parentExamId}`)
                    .then(response => response.json())
                    .then(json => {
                        callback(json.exams);
                    }).catch(() => {
                        callback();
                    });
            },
            onInitialize: function() {
                this.wrapper.style.width = '100%';
            }
        });
    }

    // Inicializar TomSelect en todos los selects existentes
    document.querySelectorAll('select[id*="component_exam"]').forEach(select => {
        initializeTomSelect(select);
    });

    // Inicializar orden de componentes existentes al cargar la página
    updateComponentOrder();

    // Si hay errores de validación, restaurar componentes marcados para eliminar
    const hasErrors = document.querySelector('.bg-red-100');
    if (hasErrors) {
        // Restaurar TODOS los componentes que puedan estar ocultos
        formsContainer.querySelectorAll('[data-formset-form]').forEach(form => {
            const deleteInput = form.querySelector('input[name*="DELETE"]');
            // Restaurar si está oculto O si tiene DELETE marcado
            if (form.style.display === 'none' || (deleteInput && deleteInput.value === 'on')) {
                form.style.display = '';
                if (deleteInput) {
                    deleteInput.value = '';
                }
            }
        });
    }

    // Función para actualizar los índices del formset
    function updateFormIndices() {
        const forms = formsContainer.querySelectorAll('[data-formset-form]');
        const totalForms = document.getElementById('id_component_items-TOTAL_FORMS');

        forms.forEach((form, index) => {
            // Actualizar todos los inputs, selects y labels con el nuevo índice
            form.querySelectorAll('input, select, label').forEach(element => {
                ['name', 'id', 'for'].forEach(attr => {
                    if (element.hasAttribute(attr)) {
                        const value = element.getAttribute(attr);
                        element.setAttribute(attr, value.replace(/component_items-\d+-/, `component_items-${index}-`));
                    }
                });
            });
        });

        if (totalForms) {
            totalForms.value = forms.length;
        }
    }

    // Agregar nuevo componente
    addButton.addEventListener('click', function() {
        const forms = formsContainer.querySelectorAll('[data-formset-form]');
        const totalForms = document.getElementById('id_component_items-TOTAL_FORMS');
        const newIndex = forms.length;
        let templateForm;

        if (forms.length > 0) {
            // Si hay formularios existentes, clonar el primero
            const firstForm = forms[0];

            // Obtener el select original y guardar su valor antes de destruir TomSelect
            const originalSelect = firstForm.querySelector('select[id*="component_exam"]');
            let originalTomSelect = null;
            let savedValue = null;

            if (originalSelect && originalSelect.tomselect) {
                originalTomSelect = originalSelect.tomselect;
                savedValue = originalSelect.tomselect.getValue(); // Guardar el valor seleccionado
                originalTomSelect.destroy();
            } else if (originalSelect) {
                savedValue = originalSelect.value; // Si no tiene TomSelect, guardar el valor del select
            }

            // Clonar el formulario con el select limpio
            templateForm = firstForm.cloneNode(true);

            // Restaurar TomSelect en el formulario original con el valor guardado
            if (originalSelect) {
                initializeTomSelect(originalSelect);
                // Restaurar el valor seleccionado
                if (savedValue && originalSelect.tomselect) {
                    originalSelect.tomselect.setValue(savedValue, true);
                }
            }
        } else {
            // Si no hay formularios, usar el template
            const template = document.getElementById('component-template');
            templateForm = template.content.firstElementChild.cloneNode(true);
        }

        // Limpiar el TomSelect clonado (si existe algún residuo)
        const clonedTomSelectWrapper = templateForm.querySelector('.ts-wrapper');
        if (clonedTomSelectWrapper) {
            clonedTomSelectWrapper.remove();
        }

        // Limpiar valores del formulario clonado
        templateForm.querySelectorAll('input, select').forEach(element => {
            if (element.type === 'checkbox' && !element.id?.includes('DELETE')) {
                element.checked = false;
            } else if (element.type === 'hidden' && element.name?.includes('-id')) {
                // Limpiar el ID (no es un objeto guardado)
                element.value = '';
            } else if (element.tagName === 'SELECT') {
                // Limpiar el select de examen
                element.value = '';
                element.selectedIndex = 0;
            }
            // Nota: NO limpiamos el campo order aquí, lo estableceremos después

            // Remover atributos de TomSelect si existen
            element.removeAttribute('data-ts-control');
            if (element.classList.contains('tomselected')) {
                element.classList.remove('tomselected');
            }
        });

        // Actualizar índices en el nuevo formulario
        templateForm.querySelectorAll('input, select, label').forEach(element => {
            ['name', 'id', 'for'].forEach(attr => {
                if (element.hasAttribute(attr)) {
                    const value = element.getAttribute(attr);
                    // Reemplazar tanto __prefix__ como índices numéricos
                    const newValue = value.replace(/__prefix__/g, newIndex).replace(/component_items-\d+-/, `component_items-${newIndex}-`);
                    element.setAttribute(attr, newValue);
                }
            });
        });

        // Establecer el orden del nuevo formulario inmediatamente
        const orderInput = templateForm.querySelector('input[name*="-order"]');
        if (orderInput) {
            orderInput.value = newIndex + 1;
        }

        // Agregar al contenedor
        formsContainer.appendChild(templateForm);

        // Actualizar contador de formularios
        if (totalForms) {
            totalForms.value = newIndex + 1;
        }

        // Re-inicializar iconos de Lucide
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Inicializar TomSelect en el nuevo selector
        const newSelect = templateForm.querySelector('select[id*="component_exam"]');
        if (newSelect) {
            // Asegurar que el select esté visible
            newSelect.style.display = 'block';
            initializeTomSelect(newSelect);
        }

        // Agregar event listener al botón de eliminar
        const removeButton = templateForm.querySelector('.remove-component');
        if (removeButton) {
            removeButton.addEventListener('click', function() {
                removeComponent(templateForm);
            });
        }

        // Actualizar orden después de agregar
        updateComponentOrder();
    });

    // Función para eliminar componente
    function removeComponent(form) {
        const deleteInput = form.querySelector('input[name*="DELETE"]');
        if (deleteInput) {
            // Si el formulario ya existe en la base de datos, marcarlo para eliminar
            const idInput = form.querySelector('input[name*="-id"]');
            if (idInput && idInput.value) {
                // Marcar como DELETE (ahora es un hidden input, no checkbox)
                deleteInput.value = 'on';
                form.style.display = 'none';
            } else {
                // Si es nuevo, simplemente removerlo
                form.remove();
                updateFormIndices();
            }
            // Actualizar orden después de eliminar
            updateComponentOrder();
        }
    }

    // Agregar event listeners a los botones de eliminar existentes
    document.querySelectorAll('.remove-component').forEach(button => {
        button.addEventListener('click', function() {
            const form = this.closest('[data-formset-form]');
            if (form) {
                removeComponent(form);
            }
        });
    });

    // Sincronizar TomSelect con los campos select antes de enviar el formulario
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Sincronizar todos los TomSelect
            document.querySelectorAll('select[id*="component_exam"]').forEach(select => {
                if (select.tomselect) {
                    const value = select.tomselect.getValue();
                    select.value = value;
                }
            });

            // Si el checkbox de has_components está deshabilitado, asegurar que se envíe su valor
            const hasComponentsCheckbox = document.querySelector('input[name="has_components"]');
            if (hasComponentsCheckbox && hasComponentsCheckbox.disabled) {
                // Habilitar temporalmente para que se envíe, o crear un campo hidden
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'has_components';
                hiddenInput.value = hasComponentsCheckbox.checked ? 'on' : '';
                form.appendChild(hiddenInput);
            }
        });
    }
});
</script>
{% endblock %}
