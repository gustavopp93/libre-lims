{% extends "base.html" %}

{% block title %}Editar Examen - {{ company.business_name }}{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    {% include 'includes/sidebar.html' %}

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        {% include 'includes/header.html' with page_title="Editar Examen" %}

        <!-- Main Content Area -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            {% include 'includes/breadcrumbs.html' %}
<div class="max-w-4xl mx-auto" x-data="{ hasComponents: {% if form.has_components.value != None %}{{ form.has_components.value|yesno:'true,false' }}{% else %}{{ exam.has_components|yesno:'true,false' }}{% endif %} }">
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-6">Editar Examen: {{ exam.name }}</h3>

        <!-- Form -->
        <form method="post">
            {% csrf_token %}

            {% if form.errors or component_formset.errors %}
            <div class="mb-4 p-4 bg-red-100 text-red-700 rounded">
                <p class="font-bold">Por favor corrija los siguientes errores:</p>
                <ul class="list-disc list-inside">
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    {% for formset_form in component_formset %}
                        {% for error in formset_form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="space-y-4">
                <!-- Código (readonly) -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Código del Examen
                    </label>
                    <div class="bg-gray-100 border border-gray-300 rounded w-full py-2 px-3 text-gray-600">
                        {{ exam.code|default:"-" }}
                    </div>
                    <p class="text-gray-500 text-xs mt-1">Este campo no se puede editar</p>
                </div>

                <!-- Nombre (editable) -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="{{ form.name.id_for_label }}">
                        {{ form.name.label }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.name }}
                </div>

                <!-- Categoría -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="{{ form.category.id_for_label }}">
                        {{ form.category.label }}
                    </label>
                    {{ form.category }}
                </div>

                <!-- Precio (editable) -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="{{ form.price.id_for_label }}">
                        {{ form.price.label }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.price }}
                </div>

                <!-- Has Components -->
                <div class="flex items-center">
                    {{ form.has_components }}
                    <label class="ml-2 text-gray-700 text-sm font-bold" for="{{ form.has_components.id_for_label }}">
                        {{ form.has_components.label }}
                    </label>
                </div>

                <!-- Components Section -->
                <div x-show="hasComponents" x-transition class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-md font-semibold text-gray-700">Componentes del Examen</h4>
                        <button type="button" id="add-component" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">
                            <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                            Agregar Componente
                        </button>
                    </div>

                    {{ component_formset.management_form }}

                    <div id="component-forms" class="space-y-4">
                        {% for form in component_formset %}
                        <div class="component-form p-4 bg-gray-50 rounded border" data-formset-form>
                            <div class="grid grid-cols-12 gap-4">
                                <div class="col-span-8">
                                    <label class="block text-gray-700 text-sm font-bold mb-2">
                                        Examen Componente
                                    </label>
                                    {{ form.component_exam }}
                                </div>
                                <div class="col-span-3">
                                    <label class="block text-gray-700 text-sm font-bold mb-2">
                                        Orden
                                    </label>
                                    {{ form.order }}
                                </div>
                                <div class="col-span-1 flex items-end">
                                    <button type="button" class="remove-component text-red-600 hover:text-red-800">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                    {{ form.DELETE }}
                                </div>
                            </div>
                            {{ form.id }}
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Template oculto para clonar cuando no hay componentes -->
                    <template id="component-template">
                        <div class="component-form p-4 bg-gray-50 rounded border" data-formset-form>
                            <div class="grid grid-cols-12 gap-4">
                                <div class="col-span-8">
                                    <label class="block text-gray-700 text-sm font-bold mb-2">
                                        Examen Componente
                                    </label>
                                    <select name="component_items-__prefix__-component_exam" id="id_component_items-__prefix__-component_exam" class="template-select shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                                        <option value="">---------</option>
                                        {% for exam in available_exams %}
                                        <option value="{{ exam.id }}">{{ exam.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-span-3">
                                    <label class="block text-gray-700 text-sm font-bold mb-2">
                                        Orden
                                    </label>
                                    <input type="number" name="component_items-__prefix__-order" value="0" id="id_component_items-__prefix__-order" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500">
                                </div>
                                <div class="col-span-1 flex items-end">
                                    <button type="button" class="remove-component text-red-600 hover:text-red-800">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                    <input type="checkbox" name="component_items-__prefix__-DELETE" id="id_component_items-__prefix__-DELETE" style="display:none;">
                                </div>
                            </div>
                            <input type="hidden" name="component_items-__prefix__-id" id="id_component_items-__prefix__-id">
                        </div>
                    </template>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex items-center justify-end space-x-4 mt-6">
                <a href="{% url 'exams_list' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Cancelar
                </a>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>
        </main>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-component');
    const formsContainer = document.getElementById('component-forms');

    if (!addButton || !formsContainer) return;

    // Inicializar TomSelect en los selectores existentes de componentes
    function initializeTomSelect(selectElement) {
        if (!selectElement) return;

        // Verificar si ya tiene TomSelect y destruirlo
        if (selectElement.tomselect) {
            selectElement.tomselect.destroy();
        }

        new TomSelect(selectElement, {
            placeholder: 'Buscar examen...',
            allowEmptyOption: false,
            create: false,
            onInitialize: function() {
                // Asegurar que el wrapper tenga el ancho correcto
                this.wrapper.style.width = '100%';
            }
        });
    }

    // Inicializar TomSelect en todos los selects existentes
    document.querySelectorAll('select[id*="component_exam"]').forEach(select => {
        initializeTomSelect(select);
    });

    // Función para actualizar los índices del formset
    function updateFormIndices() {
        const forms = formsContainer.querySelectorAll('[data-formset-form]');
        const totalForms = document.getElementById('id_component_items-TOTAL_FORMS');

        forms.forEach((form, index) => {
            // Actualizar todos los inputs, selects y labels con el nuevo índice
            form.querySelectorAll('input, select, label').forEach(element => {
                ['name', 'id', 'for'].forEach(attr => {
                    if (element.hasAttribute(attr)) {
                        const value = element.getAttribute(attr);
                        element.setAttribute(attr, value.replace(/component_items-\d+-/, `component_items-${index}-`));
                    }
                });
            });
        });

        if (totalForms) {
            totalForms.value = forms.length;
        }
    }

    // Agregar nuevo componente
    addButton.addEventListener('click', function() {
        const forms = formsContainer.querySelectorAll('[data-formset-form]');
        const totalForms = document.getElementById('id_component_items-TOTAL_FORMS');
        const newIndex = forms.length;
        let templateForm;

        if (forms.length > 0) {
            // Si hay formularios existentes, clonar el primero
            const firstForm = forms[0];

            // Obtener el select original y guardar su valor antes de destruir TomSelect
            const originalSelect = firstForm.querySelector('select[id*="component_exam"]');
            let originalTomSelect = null;
            let savedValue = null;

            if (originalSelect && originalSelect.tomselect) {
                originalTomSelect = originalSelect.tomselect;
                savedValue = originalSelect.tomselect.getValue(); // Guardar el valor seleccionado
                originalTomSelect.destroy();
            } else if (originalSelect) {
                savedValue = originalSelect.value; // Si no tiene TomSelect, guardar el valor del select
            }

            // Clonar el formulario con el select limpio
            templateForm = firstForm.cloneNode(true);

            // Restaurar TomSelect en el formulario original con el valor guardado
            if (originalSelect) {
                initializeTomSelect(originalSelect);
                // Restaurar el valor seleccionado
                if (savedValue && originalSelect.tomselect) {
                    originalSelect.tomselect.setValue(savedValue, true);
                }
            }
        } else {
            // Si no hay formularios, usar el template
            const template = document.getElementById('component-template');
            templateForm = template.content.firstElementChild.cloneNode(true);
        }

        // Limpiar el TomSelect clonado (si existe algún residuo)
        const clonedTomSelectWrapper = templateForm.querySelector('.ts-wrapper');
        if (clonedTomSelectWrapper) {
            clonedTomSelectWrapper.remove();
        }

        // Limpiar valores del formulario clonado
        templateForm.querySelectorAll('input:not([type="hidden"]), select').forEach(element => {
            if (element.type === 'checkbox') {
                element.checked = false;
            } else if (element.id && element.id.includes('DELETE')) {
                element.checked = false;
            } else {
                element.value = '';
            }

            // Remover atributos de TomSelect si existen
            element.removeAttribute('data-ts-control');
            if (element.classList.contains('tomselected')) {
                element.classList.remove('tomselected');
            }
        });

        // Actualizar índices en el nuevo formulario
        templateForm.querySelectorAll('input, select, label').forEach(element => {
            ['name', 'id', 'for'].forEach(attr => {
                if (element.hasAttribute(attr)) {
                    const value = element.getAttribute(attr);
                    element.setAttribute(attr, value.replace(/component_items-\d+-/, `component_items-${newIndex}-`));
                }
            });
        });

        // Agregar al contenedor
        formsContainer.appendChild(templateForm);

        // Actualizar contador de formularios
        if (totalForms) {
            totalForms.value = newIndex + 1;
        }

        // Re-inicializar iconos de Lucide
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Inicializar TomSelect en el nuevo selector
        const newSelect = templateForm.querySelector('select[id*="component_exam"]');
        if (newSelect) {
            // Asegurar que el select esté visible
            newSelect.style.display = 'block';
            initializeTomSelect(newSelect);
        }

        // Agregar event listener al botón de eliminar
        const removeButton = templateForm.querySelector('.remove-component');
        if (removeButton) {
            removeButton.addEventListener('click', function() {
                removeComponent(templateForm);
            });
        }
    });

    // Función para eliminar componente
    function removeComponent(form) {
        const deleteInput = form.querySelector('input[name*="DELETE"]');
        if (deleteInput) {
            // Si el formulario ya existe en la base de datos, marcarlo para eliminar
            const idInput = form.querySelector('input[name*="-id"]');
            if (idInput && idInput.value) {
                deleteInput.checked = true;
                form.style.display = 'none';
            } else {
                // Si es nuevo, simplemente removerlo
                form.remove();
                updateFormIndices();
            }
        }
    }

    // Agregar event listeners a los botones de eliminar existentes
    document.querySelectorAll('.remove-component').forEach(button => {
        button.addEventListener('click', function() {
            const form = this.closest('[data-formset-form]');
            if (form) {
                removeComponent(form);
            }
        });
    });
});
</script>
{% endblock %}
