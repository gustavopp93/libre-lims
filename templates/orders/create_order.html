{% extends "base.html" %}

{% block title %}Crear Orden - {{ company.business_name }}{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    {% include 'includes/sidebar.html' %}

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        {% include 'includes/header.html' with page_title="Crear Orden" %}

        <!-- Main Content Area -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="max-w-6xl mx-auto">
                <!-- Back Button -->
                <div class="mb-4">
                    <a href="{% url 'orders_list' %}" class="flex items-center text-blue-600 hover:text-blue-800">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                        Volver a lista de ventas
                    </a>
                </div>

                <!-- Search Patient Card -->
                <div id="tour-patient-search" class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Buscar Paciente</h3>
                        <button id="changePatientBtn" class="hidden bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm flex items-center">
                            <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                            Cambiar Paciente
                        </button>
                    </div>

                    <div id="patientSearchSection">
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Buscar Paciente</label>
                                <select id="patientSelect" placeholder="Buscar por nombre, apellido o documento..."></select>
                            </div>
                        </div>

                        <!-- Patient Not Found -->
                        <div class="mt-4 bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <p class="text-sm text-gray-700 mb-2">¿El paciente no aparece en la búsqueda?</p>
                            <a href="{% url 'patients_create' %}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded inline-block text-sm">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Crear Nuevo Paciente
                            </a>
                            <p class="text-xs text-gray-600 mt-2">Después de crear el paciente, recargue esta página y búsquelo nuevamente.</p>
                        </div>
                    </div>

                    <!-- Patient Selected Info -->
                    <div id="patientSelectedInfo" class="hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></i>
                                <div>
                                    <p class="text-sm font-semibold text-green-800">Paciente seleccionado</p>
                                    <p class="text-xs text-green-700 mt-1">
                                        <span id="selectedPatientName"></span> - <span id="selectedPatientDoc"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Found -->
                <div id="patientFound" class="hidden">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Datos del Paciente</h4>
                            <a id="editPatientBtn" href="#" target="_blank" class="bg-blue-500 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm flex items-center">
                                <i data-lucide="edit" class="w-4 h-4 mr-2"></i>
                                Editar Paciente
                            </a>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div><p class="text-sm text-gray-600">Tipo de Documento</p><p class="font-semibold" id="patientDocType"></p></div>
                            <div><p class="text-sm text-gray-600">Número de Documento</p><p class="font-semibold" id="patientDocNumber"></p></div>
                            <div><p class="text-sm text-gray-600">Nombres</p><p class="font-semibold" id="patientFirstName"></p></div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div><p class="text-sm text-gray-600">Apellidos</p><p class="font-semibold" id="patientLastName"></p></div>
                            <div><p class="text-sm text-gray-600">Edad</p><p class="font-semibold" id="patientAge"></p></div>
                            <div><p class="text-sm text-gray-600">Teléfono</p><p class="font-semibold" id="patientPhone"></p></div>
                        </div>

                        <!-- Presunciones Diagnósticas -->
                        <div id="diagnosisSection" class="border-t pt-4 mb-6">
                            <h5 class="text-sm font-semibold text-gray-700 mb-2">Presunción Médica</h5>
                            <p id="patientDiagnosis" class="text-sm text-gray-600 italic"></p>
                        </div>

                        <!-- Últimas Órdenes -->
                        <div id="recentOrdersSection" class="border-t pt-4">
                            <div class="flex justify-between items-center mb-3">
                                <h5 class="text-sm font-semibold text-gray-700">Últimas Órdenes</h5>
                                <a id="viewAllOrdersLink" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                                    <span>Ver más</span>
                                    <i data-lucide="external-link" class="w-4 h-4 ml-1"></i>
                                </a>
                            </div>
                            <div id="recentOrdersContainer"></div>
                        </div>
                    </div>

                    <!-- Coupon Section -->
                    <div id="tour-coupon" class="bg-white rounded-lg shadow p-6 mb-6">
                        <h4 class="text-lg font-semibold mb-4">Cupón de Descuento (Opcional)</h4>
                        <div class="grid grid-cols-12 gap-4">
                            <div class="col-span-8">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Código de Cupón</label>
                                <input type="text" id="couponCodeInput" class="shadow border rounded w-full py-2 px-3 text-gray-700 uppercase" placeholder="Ingrese código de cupón..." maxlength="20">
                            </div>
                            <div class="col-span-4 flex items-end">
                                <button type="button" id="applyCouponBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded w-full">
                                    Aplicar Cupón
                                </button>
                            </div>
                        </div>

                        <!-- Coupon Status Messages -->
                        <div id="couponSuccess" class="hidden mt-4 bg-green-50 border border-green-200 rounded p-4">
                            <div class="flex items-center">
                                <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></i>
                                <div>
                                    <p class="text-sm font-semibold text-green-800">Cupón aplicado correctamente</p>
                                    <p class="text-xs text-green-700 mt-1">
                                        Tarifario: <span id="couponPriceListName"></span>
                                        <span id="couponExpirationDate"></span>
                                    </p>
                                </div>
                                <button type="button" id="removeCouponBtn" class="ml-auto text-red-600 hover:text-red-800 text-sm underline">
                                    Quitar
                                </button>
                            </div>
                        </div>

                        <div id="couponError" class="hidden mt-4 bg-red-50 border border-red-200 rounded p-4">
                            <div class="flex items-center">
                                <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mr-2"></i>
                                <p class="text-sm text-red-800" id="couponErrorMessage"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Exams Section -->
                    <div id="tour-exams" class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="flex justify-between mb-4">
                            <h4 class="text-lg font-semibold">Exámenes Solicitados</h4>
                            <button id="addExamRowBtn" class="bg-green-500 text-white px-4 py-2 rounded">Agregar Examen</button>
                        </div>
                        <div id="examsContainer" class="space-y-3"></div>
                    </div>

                    <!-- Total and Actions -->
                    <div id="tour-total" class="bg-white rounded-lg shadow p-6">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Observaciones</label>
                            <textarea id="observations" rows="3" class="shadow border rounded w-full py-2 px-3 text-gray-700" placeholder="Observaciones adicionales..."></textarea>
                        </div>

                        <div class="flex justify-between items-center">
                            <div class="text-2xl font-bold text-gray-800">
                                Total: S/. <span id="totalAmount">0.00</span>
                            </div>
                            <button id="createSaleBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded">
                                Crear Orden
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        let examRowCount = 0;
        let tomSelectInstances = {};
        let patientTomSelect = null;
        let currentPatientId = null;
        let appliedCouponCode = null;

        // Inicializar TomSelect para pacientes
        patientTomSelect = new TomSelect('#patientSelect', {
            valueField: 'id',
            labelField: 'full_name',
            searchField: ['first_name', 'last_name', 'document_number'],
            placeholder: 'Buscar por nombre, apellido o documento...',
            load: function(query, callback) {
                if (!query.length || query.length < 2) return callback();

                fetch('/api/patients/search/?query=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        // Agregar campo full_name para display
                        const patients = (data.patients || []).map(p => ({
                            ...p,
                            full_name: `${p.last_name}, ${p.first_name}`
                        }));
                        callback(patients);
                    })
                    .catch(() => {
                        callback();
                    });
            },
            render: {
                option: function(item, escape) {
                    return `<div>
                        <div class="font-semibold">${escape(item.last_name)}, ${escape(item.first_name)}</div>
                        <div class="text-sm text-gray-600">${escape(item.document_type)}: ${escape(item.document_number)}</div>
                    </div>`;
                },
                item: function(item, escape) {
                    return `<div>${escape(item.last_name)}, ${escape(item.first_name)} - ${escape(item.document_type)}: ${escape(item.document_number)}</div>`;
                }
            },
            onChange: async function(value) {
                if (value) {
                    const selectedOption = this.options[value];
                    if (selectedOption) {
                        currentPatientId = value;

                        // Actualizar UI de búsqueda
                        document.getElementById('patientSearchSection').classList.add('hidden');
                        document.getElementById('patientSelectedInfo').classList.remove('hidden');
                        document.getElementById('changePatientBtn').classList.remove('hidden');
                        document.getElementById('selectedPatientName').textContent = `${selectedOption.last_name}, ${selectedOption.first_name}`;
                        document.getElementById('selectedPatientDoc').textContent = `${selectedOption.document_type}: ${selectedOption.document_number}`;

                        // Cargar detalles completos del paciente
                        await loadPatientDetails(value);

                        document.getElementById('patientFound').classList.remove('hidden');

                        // Limpiar exámenes anteriores
                        document.getElementById('examsContainer').innerHTML = '';
                        document.getElementById('couponCodeInput').value = '';
                        document.getElementById('observations').value = '';
                        appliedCouponCode = null;
                        document.getElementById('couponSuccess').classList.add('hidden');
                        document.getElementById('couponError').classList.add('hidden');
                        Object.values(tomSelectInstances).forEach(instance => instance.destroy());
                        tomSelectInstances = {};
                        examRowCount = 0;
                        updateTotal();
                        addExamRow();

                        lucide.createIcons();
                    }
                } else {
                    currentPatientId = null;
                    document.getElementById('patientFound').classList.add('hidden');
                }
            }
        });

        document.getElementById('addExamRowBtn').addEventListener('click', addExamRow);

        // Botón cambiar paciente
        document.getElementById('changePatientBtn').addEventListener('click', function() {
            // Mostrar búsqueda de nuevo
            document.getElementById('patientSearchSection').classList.remove('hidden');
            document.getElementById('patientSelectedInfo').classList.add('hidden');
            document.getElementById('changePatientBtn').classList.add('hidden');

            // Ocultar detalles del paciente
            document.getElementById('patientFound').classList.add('hidden');

            // Limpiar selección
            if (patientTomSelect) {
                patientTomSelect.clear();
            }
            currentPatientId = null;

            lucide.createIcons();
        });

        // Función para cargar detalles del paciente
        async function loadPatientDetails(patientId) {
            try {
                const response = await fetch(`/api/patients/details/?patient_id=${patientId}`);
                const data = await response.json();

                if (response.ok) {
                    const patient = data.patient;
                    const recentOrders = data.recent_orders;

                    // Actualizar datos básicos
                    document.getElementById('patientDocType').textContent = patient.document_type;
                    document.getElementById('patientDocNumber').textContent = patient.document_number;
                    document.getElementById('patientFirstName').textContent = patient.first_name;
                    document.getElementById('patientLastName').textContent = patient.last_name;
                    document.getElementById('patientAge').textContent = patient.age + ' años';
                    document.getElementById('patientPhone').textContent = patient.phone_number;

                    // Actualizar enlace de editar paciente
                    document.getElementById('editPatientBtn').href = `/patients/${patient.id}/update/`;

                    // Actualizar presunción médica
                    const diagnosisEl = document.getElementById('patientDiagnosis');
                    if (patient.presumptive_diagnosis && patient.presumptive_diagnosis.trim() !== '') {
                        diagnosisEl.textContent = patient.presumptive_diagnosis;
                        diagnosisEl.classList.remove('text-gray-400');
                        diagnosisEl.classList.add('text-gray-600');
                    } else {
                        diagnosisEl.textContent = 'Sin presunción médica registrada';
                        diagnosisEl.classList.remove('text-gray-600');
                        diagnosisEl.classList.add('text-gray-400');
                    }

                    // Actualizar enlace "Ver más"
                    const viewAllLink = document.getElementById('viewAllOrdersLink');
                    viewAllLink.href = `/orders/?document_type=${patient.document_type}&document_number=${patient.document_number}`;

                    // Renderizar últimas órdenes
                    const ordersContainer = document.getElementById('recentOrdersContainer');
                    if (recentOrders.length === 0) {
                        ordersContainer.innerHTML = '<p class="text-sm text-gray-400 italic">No hay órdenes registradas</p>';
                    } else {
                        ordersContainer.innerHTML = recentOrders.map(order => {
                            let statusBadge = '';
                            if (order.status === 'pending') {
                                statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendiente</span>';
                            } else if (order.status === 'paid') {
                                statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Pagado</span>';
                            } else if (order.status === 'voided') {
                                statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Anulado</span>';
                            }

                            return `
                                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                                    <div class="flex-1">
                                        <a href="/orders/${order.id}/" target="_blank" class="text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline">${order.code}</a>
                                        <p class="text-xs text-gray-500">${order.created_at}</p>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <p class="text-sm font-semibold text-gray-900">S/. ${order.total}</p>
                                        ${statusBadge}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }

                    lucide.createIcons();
                } else {
                    console.error('Error cargando detalles del paciente:', data.error);
                }
            } catch (error) {
                console.error('Error cargando detalles del paciente:', error);
            }
        }

        // Coupon validation
        document.getElementById('applyCouponBtn').addEventListener('click', async function() {
            const couponCode = document.getElementById('couponCodeInput').value.trim().toUpperCase();

            if (!couponCode) {
                document.getElementById('couponError').classList.remove('hidden');
                document.getElementById('couponErrorMessage').textContent = 'Debe ingresar un código de cupón';
                document.getElementById('couponSuccess').classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`/pricing/api/validate-coupon/?coupon_code=${encodeURIComponent(couponCode)}`);
                const data = await response.json();

                if (data.valid) {
                    // Cupón válido
                    appliedCouponCode = couponCode;
                    document.getElementById('couponPriceListName').textContent = data.coupon.price_list_name;

                    if (data.coupon.expiration_date) {
                        document.getElementById('couponExpirationDate').textContent = ` | Vence: ${data.coupon.expiration_date}`;
                    } else {
                        document.getElementById('couponExpirationDate').textContent = '';
                    }

                    document.getElementById('couponSuccess').classList.remove('hidden');
                    document.getElementById('couponError').classList.add('hidden');
                    document.getElementById('couponCodeInput').disabled = true;

                    // Recalcular precios de todos los exámenes con el cupón aplicado
                    await recalculateAllPrices();

                    lucide.createIcons();
                } else {
                    // Cupón inválido
                    appliedCouponCode = null;
                    document.getElementById('couponError').classList.remove('hidden');
                    document.getElementById('couponErrorMessage').textContent = data.error || 'Cupón no válido';
                    document.getElementById('couponSuccess').classList.add('hidden');
                }
            } catch (error) {
                document.getElementById('couponError').classList.remove('hidden');
                document.getElementById('couponErrorMessage').textContent = 'Error al validar el cupón';
                document.getElementById('couponSuccess').classList.add('hidden');
            }
        });

        // Remove coupon
        document.getElementById('removeCouponBtn').addEventListener('click', async function() {
            appliedCouponCode = null;
            document.getElementById('couponCodeInput').value = '';
            document.getElementById('couponCodeInput').disabled = false;
            document.getElementById('couponSuccess').classList.add('hidden');
            document.getElementById('couponError').classList.add('hidden');

            // Recalcular precios sin cupón
            await recalculateAllPrices();
        });

        document.getElementById('createSaleBtn').addEventListener('click', async function() {
            if (!currentPatientId) {
                alert('Debe buscar y seleccionar un paciente');
                return;
            }

            // Recolectar detalles de exámenes
            const examDetails = [];
            let hasErrors = false;

            Object.keys(tomSelectInstances).forEach(rowId => {
                const examId = tomSelectInstances[rowId].getValue();
                const priceInput = document.getElementById('examPrice' + rowId);
                const price = priceInput.value;

                if (!examId) {
                    alert('Debe seleccionar un examen en todas las filas');
                    hasErrors = true;
                    return;
                }

                if (!price || parseFloat(price) <= 0) {
                    alert('Todos los precios deben ser mayores a 0');
                    hasErrors = true;
                    return;
                }

                // Validar que tenga máximo 2 decimales
                const priceStr = price.toString();
                const decimalPart = priceStr.split('.')[1];
                if (decimalPart && decimalPart.length > 2) {
                    alert('Los precios deben tener máximo 2 decimales');
                    hasErrors = true;
                    return;
                }

                examDetails.push({
                    exam_id: parseInt(examId),
                    price: parseFloat(price).toFixed(2)
                });
            });

            if (hasErrors) return;

            if (examDetails.length === 0) {
                alert('Debe agregar al menos un examen');
                return;
            }

            const observations = document.getElementById('observations').value;

            // Crear venta vía AJAX
            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                    document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

                const response = await fetch('/api/orders/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        patient_id: currentPatientId,
                        coupon_code: appliedCouponCode || '',
                        observations: observations,
                        exam_details: examDetails
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Redirigir al detalle de la venta (el mensaje se mostrará ahí)
                    window.location.href = '/orders/' + data.order_id + '/';
                } else {
                    alert('Error: ' + (data.error || 'No se pudo crear la venta'));
                }
            } catch (error) {
                alert('Error al crear la venta: ' + error.message);
            }
        });

        function addExamRow() {
            const rowId = examRowCount++;
            const row = document.createElement('div');
            row.className = 'grid grid-cols-12 gap-4';
            row.id = 'examRow' + rowId;

            row.innerHTML = `
            <div class="col-span-6">
                <label class="block text-sm font-bold mb-2">Examen</label>
                <select id="examSelect${rowId}" class="w-full" placeholder="Buscar examen..."></select>
            </div>
            <div class="col-span-4">
                <label class="block text-sm font-bold mb-2">Precio</label>
                <input type="number" id="examPrice${rowId}" step="0.01" min="0" class="shadow border rounded w-full py-2 px-3" placeholder="0.00" required>
            </div>
            <div class="col-span-2 flex items-end">
                <button type="button" onclick="removeExamRow(${rowId})" class="bg-red-500 text-white px-4 py-2 rounded w-full">Eliminar</button>
            </div>
        `;

            document.getElementById('examsContainer').appendChild(row);
            lucide.createIcons();
            setupTomSelect(rowId);
        }

        function setupTomSelect(rowId) {
            const selectElement = document.getElementById('examSelect' + rowId);
            const priceInput = document.getElementById('examPrice' + rowId);

            // Event listener para actualizar total cuando cambia el precio
            priceInput.addEventListener('input', function() {
                // Validar que solo tenga números y máximo 2 decimales
                let value = this.value;

                // Permitir solo números y un punto decimal
                value = value.replace(/[^\d.]/g, '');

                // Asegurar solo un punto decimal
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                // Limitar a 2 decimales
                if (parts[1] && parts[1].length > 2) {
                    value = parts[0] + '.' + parts[1].substring(0, 2);
                }

                this.value = value;
                updateTotal();
            });

            tomSelectInstances[rowId] = new TomSelect(selectElement, {
                valueField: 'id',
                labelField: 'name',
                searchField: 'name',
                placeholder: 'Buscar examen...',
                load: function(query, callback) {
                    if (!query.length || query.length < 2) return callback();

                    fetch('/api/exams/search/?name=' + encodeURIComponent(query))
                        .then(response => response.json())
                        .then(data => {
                            callback(data.exams || []);
                        })
                        .catch(() => {
                            callback();
                        });
                },
                render: {
                    option: function(item, escape) {
                        return `<div class="font-semibold">${escape(item.name)}</div>`;
                    },
                    item: function(item, escape) {
                        return `<div>${escape(item.name)}</div>`;
                    }
                },
                onChange: async function(value) {
                    if (value) {
                        // Obtener precio usando el servicio de pricing
                        try {
                            let url = `/pricing/api/exam-price/?exam_id=${value}`;

                            // Agregar cupón si está aplicado
                            if (appliedCouponCode) {
                                url += `&coupon_code=${encodeURIComponent(appliedCouponCode)}`;
                            }

                            const response = await fetch(url);
                            const data = await response.json();

                            if (data.price) {
                                priceInput.value = parseFloat(data.price).toFixed(2);
                                updateTotal();
                            }
                        } catch (error) {
                            console.error('Error obteniendo precio:', error);
                        }
                    }
                }
            });
        }

        function removeExamRow(rowId) {
            const row = document.getElementById('examRow' + rowId);
            if (row) {
                if (tomSelectInstances[rowId]) {
                    tomSelectInstances[rowId].destroy();
                    delete tomSelectInstances[rowId];
                }
                row.remove();
                updateTotal();
            }
        }

        function updateTotal() {
            let total = 0;
            Object.keys(tomSelectInstances).forEach(rowId => {
                const priceInput = document.getElementById('examPrice' + rowId);
                const price = parseFloat(priceInput.value) || 0;
                total += price;
            });
            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }

        async function recalculateAllPrices() {
            // Recalcular el precio de cada examen con o sin cupón
            for (const rowId of Object.keys(tomSelectInstances)) {
                const examId = tomSelectInstances[rowId].getValue();
                if (examId) {
                    try {
                        let url = `/pricing/api/exam-price/?exam_id=${examId}`;

                        // Agregar cupón si está aplicado
                        if (appliedCouponCode) {
                            url += `&coupon_code=${encodeURIComponent(appliedCouponCode)}`;
                        }

                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.price) {
                            const priceInput = document.getElementById('examPrice' + rowId);
                            priceInput.value = parseFloat(data.price).toFixed(2);
                        }
                    } catch (error) {
                        console.error('Error recalculando precio:', error);
                    }
                }
            }
            updateTotal();
        }

        // Create Order Tour Configuration
        const createOrderTour = new Shepherd.Tour({
            useModalOverlay: true,
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                classes: 'shadow-lg',
                scrollTo: { behavior: 'smooth', block: 'center' }
            }
        });

        createOrderTour.addStep({
            id: 'patient-search',
            text: 'Comienza buscando al paciente por nombre, apellido o número de documento. Si el paciente no existe, puedes crearlo usando el botón "Crear Nuevo Paciente".',
            title: 'Paso 1: Buscar Paciente',
            attachTo: {
                element: '#tour-patient-search',
                on: 'bottom'
            },
            buttons: [
                {
                    text: 'Siguiente',
                    action: createOrderTour.next
                }
            ]
        });

        createOrderTour.addStep({
            id: 'coupon',
            text: 'Si el paciente tiene un cupón de descuento, ingrésalo aquí. El sistema validará el cupón y aplicará automáticamente el tarifario especial.',
            title: 'Paso 2: Cupón de Descuento (Opcional)',
            attachTo: {
                element: '#tour-coupon',
                on: 'bottom'
            },
            buttons: [
                {
                    text: 'Anterior',
                    action: createOrderTour.back
                },
                {
                    text: 'Siguiente',
                    action: createOrderTour.next
                }
            ]
        });

        createOrderTour.addStep({
            id: 'exams',
            text: 'Agrega los exámenes solicitados haciendo clic en "Agregar Examen". Los precios se calculan automáticamente según el tarifario del cupón (si aplica) o el precio base.',
            title: 'Paso 3: Agregar Exámenes',
            attachTo: {
                element: '#tour-exams',
                on: 'bottom'
            },
            buttons: [
                {
                    text: 'Anterior',
                    action: createOrderTour.back
                },
                {
                    text: 'Siguiente',
                    action: createOrderTour.next
                }
            ]
        });

        createOrderTour.addStep({
            id: 'add-exam-btn',
            text: 'Usa este botón para agregar más exámenes a la orden. Puedes agregar tantos exámenes como necesites.',
            title: 'Botón Agregar Examen',
            attachTo: {
                element: '#addExamRowBtn',
                on: 'left'
            },
            buttons: [
                {
                    text: 'Anterior',
                    action: createOrderTour.back
                },
                {
                    text: 'Siguiente',
                    action: createOrderTour.next
                }
            ]
        });

        createOrderTour.addStep({
            id: 'total',
            text: 'Aquí verás el total de la orden y podrás agregar observaciones adicionales. Cuando esté listo, haz clic en "Crear Orden" para finalizar.',
            title: 'Paso 4: Total y Crear Orden',
            attachTo: {
                element: '#tour-total',
                on: 'top'
            },
            buttons: [
                {
                    text: 'Anterior',
                    action: createOrderTour.back
                },
                {
                    text: 'Siguiente',
                    action: createOrderTour.next
                }
            ]
        });

        createOrderTour.addStep({
            id: 'help',
            text: 'Si necesitas ver este tour de nuevo, siempre puedes hacer clic en el botón de ayuda en el menú lateral.',
            title: '¿Necesitas ayuda?',
            attachTo: {
                element: '#helpButton',
                on: 'right'
            },
            buttons: [
                {
                    text: 'Anterior',
                    action: createOrderTour.back
                },
                {
                    text: 'Finalizar',
                    action: createOrderTour.complete
                }
            ]
        });

        // Check if user has seen the create order tour
        const hasSeenCreateOrderTour = localStorage.getItem('hasSeenCreateOrderTour');

        // Auto-start tour for first-time users
        if (!hasSeenCreateOrderTour) {
            setTimeout(() => {
                createOrderTour.start();
                localStorage.setItem('hasSeenCreateOrderTour', 'true');
            }, 800);
        }

        // Help button to restart tour
        const helpButton = document.getElementById('helpButton');
        if (helpButton) {
            // Remove any existing listeners
            const newButton = helpButton.cloneNode(true);
            helpButton.parentNode.replaceChild(newButton, helpButton);

            // Add new listener
            newButton.addEventListener('click', function(e) {
                e.preventDefault();
                createOrderTour.start();
            });
        }
    </script>
{% endblock %}
