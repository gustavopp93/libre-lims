{% extends "base.html" %}

{% block title %}Crear Orden de Referido - {{ company.business_name }}{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    {% include 'includes/sidebar.html' %}

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        {% include 'includes/header.html' with page_title="Crear Orden de Referido" %}

        <!-- Main Content Area -->
        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
            <div class="max-w-6xl mx-auto">
                <!-- Back Button -->
                <div class="mb-4">
                    <a href="{% url 'orders_list' %}" class="flex items-center text-blue-600 hover:text-blue-800">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                        Volver a lista de ventas
                    </a>
                </div>

                <!-- Step 1: Search Referral Card -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Paso 1: Buscar Referido</h3>

                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Buscar por Nombre de Negocio o RUC</label>
                            <select id="referralSelect" placeholder="Buscar referido..."></select>
                        </div>
                    </div>
                </div>

                <!-- Referral Selected -->
                <div id="referralSelected" class="hidden">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h4 class="text-lg font-semibold mb-4">Datos del Referido</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div><p class="text-sm text-gray-600">Negocio</p><p class="font-semibold" id="referralBusinessName"></p></div>
                            <div><p class="text-sm text-gray-600">RUC</p><p class="font-semibold" id="referralDocNumber"></p></div>
                            <div><p class="text-sm text-gray-600">Tarifario</p><p class="font-semibold" id="referralPriceList"></p></div>
                        </div>
                    </div>

                    <!-- Step 2: Search Patient Card -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Paso 2: Buscar Paciente</h3>

                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Buscar Paciente</label>
                                <select id="patientSelect" placeholder="Buscar por nombre, apellido o documento..."></select>
                            </div>
                        </div>

                        <!-- Patient Not Found -->
                        <div class="mt-4 bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <p class="text-sm text-gray-700 mb-2">¿El paciente no aparece en la búsqueda?</p>
                            <a href="{% url 'patients_create' %}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded inline-block text-sm">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                                Crear Nuevo Paciente
                            </a>
                            <p class="text-xs text-gray-600 mt-2">Después de crear el paciente, recargue esta página y búsquelo nuevamente.</p>
                        </div>
                    </div>

                    <!-- Patient Found -->
                    <div id="patientFound" class="hidden">
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <h4 class="text-lg font-semibold mb-4">Datos del Paciente</h4>
                            <div class="grid grid-cols-4 gap-4">
                                <div><p class="text-sm text-gray-600">Tipo de Documento</p><p class="font-semibold" id="patientDocType"></p></div>
                                <div><p class="text-sm text-gray-600">Número de Documento</p><p class="font-semibold" id="patientDocNumber"></p></div>
                                <div><p class="text-sm text-gray-600">Nombres</p><p class="font-semibold" id="patientFirstName"></p></div>
                                <div><p class="text-sm text-gray-600">Apellidos</p><p class="font-semibold" id="patientLastName"></p></div>
                            </div>
                        </div>

                        <!-- Exams Section -->
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <div class="flex justify-between mb-4">
                                <h4 class="text-lg font-semibold">Exámenes Solicitados</h4>
                                <button id="addExamRowBtn" class="bg-green-500 text-white px-4 py-2 rounded">Agregar Examen</button>
                            </div>
                            <div id="examsContainer" class="space-y-3"></div>
                        </div>

                        <!-- Total and Actions -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Observaciones</label>
                                <textarea id="observations" rows="3" class="shadow border rounded w-full py-2 px-3 text-gray-700" placeholder="Observaciones adicionales..."></textarea>
                            </div>

                            <div class="flex justify-between items-center">
                                <div class="text-2xl font-bold text-gray-800">
                                    Total: S/. <span id="totalAmount">0.00</span>
                                </div>
                                <button id="createSaleBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded">
                                    Crear Orden de Referido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        let examRowCount = 0;
        let tomSelectInstances = {};
        let referralTomSelect = null;
        let patientTomSelect = null;
        let currentReferralId = null;
        let currentPriceListId = null;
        let currentPatientId = null;

        // Inicializar TomSelect para referidos
        referralTomSelect = new TomSelect('#referralSelect', {
            valueField: 'id',
            labelField: 'business_name',
            searchField: ['business_name', 'document_number'],
            placeholder: 'Buscar por nombre de negocio o RUC...',
            load: function(query, callback) {
                if (!query.length || query.length < 2) return callback();

                fetch('/api/referrals/search/?query=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        callback(data.referrals || []);
                    })
                    .catch(() => {
                        callback();
                    });
            },
            render: {
                option: function(item, escape) {
                    return `<div>
                        <div class="font-semibold">${escape(item.business_name)}</div>
                        <div class="text-sm text-gray-600">RUC: ${escape(item.document_number)} | Tarifario: ${escape(item.price_list_name)}</div>
                    </div>`;
                },
                item: function(item, escape) {
                    return `<div>${escape(item.business_name)} - ${escape(item.document_number)}</div>`;
                }
            },
            onChange: function(value) {
                if (value) {
                    const selectedOption = this.options[value];
                    if (selectedOption) {
                        currentReferralId = value;
                        currentPriceListId = selectedOption.price_list_id;

                        document.getElementById('referralBusinessName').textContent = selectedOption.business_name;
                        document.getElementById('referralDocNumber').textContent = selectedOption.document_number;
                        document.getElementById('referralPriceList').textContent = selectedOption.price_list_name;

                        document.getElementById('referralSelected').classList.remove('hidden');

                        // Inicializar TomSelect para pacientes si aún no existe
                        if (!patientTomSelect) {
                            initializePatientTomSelect();
                        } else {
                            // Limpiar selección de paciente si existía
                            patientTomSelect.clear();
                            patientTomSelect.clearOptions();
                        }

                        // Limpiar datos de paciente
                        currentPatientId = null;
                        document.getElementById('patientFound').classList.add('hidden');

                        lucide.createIcons();
                    }
                } else {
                    currentReferralId = null;
                    currentPriceListId = null;
                    document.getElementById('referralSelected').classList.add('hidden');
                }
            }
        });

        // Inicializar TomSelect para pacientes
        function initializePatientTomSelect() {
            patientTomSelect = new TomSelect('#patientSelect', {
                valueField: 'id',
                labelField: 'full_name',
                searchField: ['first_name', 'last_name', 'document_number'],
                placeholder: 'Buscar por nombre, apellido o documento...',
                load: function(query, callback) {
                    if (!currentReferralId) {
                        callback();
                        return;
                    }

                    if (!query.length || query.length < 2) return callback();

                    fetch(`/api/referrals/patients/?referral_id=${currentReferralId}&query=` + encodeURIComponent(query))
                        .then(response => response.json())
                        .then(data => {
                            // Agregar campo full_name para display
                            const patients = (data.patients || []).map(p => ({
                                ...p,
                                full_name: `${p.last_name}, ${p.first_name}`
                            }));
                            callback(patients);
                        })
                        .catch(() => {
                            callback();
                        });
                },
                render: {
                    option: function(item, escape) {
                        return `<div>
                            <div class="font-semibold">${escape(item.last_name)}, ${escape(item.first_name)}</div>
                            <div class="text-sm text-gray-600">${escape(item.document_type)}: ${escape(item.document_number)}</div>
                        </div>`;
                    },
                    item: function(item, escape) {
                        return `<div>${escape(item.last_name)}, ${escape(item.first_name)} - ${escape(item.document_type)}: ${escape(item.document_number)}</div>`;
                    }
                },
                onChange: function(value) {
                    if (value) {
                        const selectedOption = this.options[value];
                        if (selectedOption) {
                            currentPatientId = value;

                            document.getElementById('patientDocType').textContent = selectedOption.document_type;
                            document.getElementById('patientDocNumber').textContent = selectedOption.document_number;
                            document.getElementById('patientFirstName').textContent = selectedOption.first_name;
                            document.getElementById('patientLastName').textContent = selectedOption.last_name;

                            document.getElementById('patientFound').classList.remove('hidden');

                            // Limpiar exámenes anteriores
                            document.getElementById('examsContainer').innerHTML = '';
                            document.getElementById('observations').value = '';
                            Object.values(tomSelectInstances).forEach(instance => instance.destroy());
                            tomSelectInstances = {};
                            examRowCount = 0;
                            updateTotal();
                            addExamRow();

                            lucide.createIcons();
                        }
                    } else {
                        currentPatientId = null;
                        document.getElementById('patientFound').classList.add('hidden');
                    }
                }
            });
        }

        document.getElementById('addExamRowBtn').addEventListener('click', addExamRow);

        document.getElementById('createSaleBtn').addEventListener('click', async function() {
            if (!currentReferralId) {
                alert('Debe seleccionar un referido');
                return;
            }

            if (!currentPatientId) {
                alert('Debe seleccionar un paciente');
                return;
            }

            // Recolectar detalles de exámenes
            const examDetails = [];
            let hasErrors = false;

            Object.keys(tomSelectInstances).forEach(rowId => {
                const examId = tomSelectInstances[rowId].getValue();
                const priceInput = document.getElementById('examPrice' + rowId);
                const price = priceInput.value;

                if (!examId) {
                    alert('Debe seleccionar un examen en todas las filas');
                    hasErrors = true;
                    return;
                }

                if (!price || parseFloat(price) <= 0) {
                    alert('Todos los precios deben ser mayores a 0');
                    hasErrors = true;
                    return;
                }

                const priceStr = price.toString();
                const decimalPart = priceStr.split('.')[1];
                if (decimalPart && decimalPart.length > 2) {
                    alert('Los precios deben tener máximo 2 decimales');
                    hasErrors = true;
                    return;
                }

                examDetails.push({
                    exam_id: parseInt(examId),
                    price: parseFloat(price).toFixed(2)
                });
            });

            if (hasErrors) return;

            if (examDetails.length === 0) {
                alert('Debe agregar al menos un examen');
                return;
            }

            const observations = document.getElementById('observations').value;

            try {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                    document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

                const response = await fetch('/api/orders/referral/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        referral_id: currentReferralId,
                        patient_id: currentPatientId,
                        observations: observations,
                        exam_details: examDetails
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    window.location.href = '/orders/' + data.order_id + '/';
                } else {
                    alert('Error: ' + (data.error || 'No se pudo crear la orden'));
                }
            } catch (error) {
                alert('Error al crear la orden: ' + error.message);
            }
        });

        function addExamRow() {
            const rowId = examRowCount++;
            const row = document.createElement('div');
            row.className = 'grid grid-cols-12 gap-4';
            row.id = 'examRow' + rowId;

            row.innerHTML = `
            <div class="col-span-6">
                <label class="block text-sm font-bold mb-2">Examen</label>
                <select id="examSelect${rowId}" class="w-full" placeholder="Buscar examen..."></select>
            </div>
            <div class="col-span-4">
                <label class="block text-sm font-bold mb-2">Precio</label>
                <input type="number" id="examPrice${rowId}" step="0.01" min="0" class="shadow border rounded w-full py-2 px-3" placeholder="0.00" required>
            </div>
            <div class="col-span-2 flex items-end">
                <button type="button" onclick="removeExamRow(${rowId})" class="bg-red-500 text-white px-4 py-2 rounded w-full">Eliminar</button>
            </div>
        `;

            document.getElementById('examsContainer').appendChild(row);
            lucide.createIcons();
            setupTomSelect(rowId);
        }

        function setupTomSelect(rowId) {
            const selectElement = document.getElementById('examSelect' + rowId);
            const priceInput = document.getElementById('examPrice' + rowId);

            priceInput.addEventListener('input', function() {
                let value = this.value;
                value = value.replace(/[^\d.]/g, '');

                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                if (parts[1] && parts[1].length > 2) {
                    value = parts[0] + '.' + parts[1].substring(0, 2);
                }

                this.value = value;
                updateTotal();
            });

            tomSelectInstances[rowId] = new TomSelect(selectElement, {
                valueField: 'id',
                labelField: 'name',
                searchField: 'name',
                placeholder: 'Buscar examen...',
                load: function(query, callback) {
                    if (!query.length || query.length < 2) return callback();

                    fetch('/api/exams/search/?name=' + encodeURIComponent(query))
                        .then(response => response.json())
                        .then(data => {
                            callback(data.exams || []);
                        })
                        .catch(() => {
                            callback();
                        });
                },
                render: {
                    option: function(item, escape) {
                        return `<div class="font-semibold">${escape(item.name)}</div>`;
                    },
                    item: function(item, escape) {
                        return `<div>${escape(item.name)}</div>`;
                    }
                },
                onChange: async function(value) {
                    if (value) {
                        // Obtener precio usando el servicio de pricing
                        try {
                            const url = `/pricing/api/exam-price/?exam_id=${value}` +
                                        (currentReferralId ? `&referral_id=${currentReferralId}` : '');

                            const response = await fetch(url);
                            const data = await response.json();

                            if (data.price) {
                                priceInput.value = parseFloat(data.price).toFixed(2);
                                updateTotal();
                            }
                        } catch (error) {
                            console.error('Error obteniendo precio:', error);
                            // En caso de error, usar precio base del examen
                            const selectedOption = this.options[value];
                            if (selectedOption) {
                                priceInput.value = parseFloat(selectedOption.price).toFixed(2);
                                updateTotal();
                            }
                        }
                    }
                }
            });
        }

        function removeExamRow(rowId) {
            const row = document.getElementById('examRow' + rowId);
            if (row) {
                if (tomSelectInstances[rowId]) {
                    tomSelectInstances[rowId].destroy();
                    delete tomSelectInstances[rowId];
                }
                row.remove();
                updateTotal();
            }
        }

        function updateTotal() {
            let total = 0;
            Object.keys(tomSelectInstances).forEach(rowId => {
                const priceInput = document.getElementById('examPrice' + rowId);
                const price = parseFloat(priceInput.value) || 0;
                total += price;
            });
            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }
    </script>
{% endblock %}
